//@version=6
strategy("XAUUSD EMA Slope Strategy with Confluence & Labels", overlay=true, margin_long=100, margin_short=100)

// === INPUTS ===
emaFastLen = input.int(9, "Fast EMA Length")
emaSlowLen = input.int(20, "Slow EMA Length")
rr = input.float(2.0, "Risk/Reward Ratio")
slopeThresh = input.float(0.02, "Minimum EMA Slope Difference") // EMA slope filter
volMAperiod = input.int(20, "Volume MA Period")
strongCandlePerc = input.float(0.6, "Strong Candle Body % of Range") // 60% of candle

// === EMA CALCULATION ===
emaFast = ta.ema(close, emaFastLen)
emaSlow = ta.ema(close, emaSlowLen)

// === SLOPE CALCULATION ===
slopeFast = emaFast - emaFast[1]
slopeSlow = emaSlow - emaSlow[1]

// === VOLUME FILTER ===
volMA = ta.sma(volume, volMAperiod)
volumeOk = volume > volMA

// === STRONG CANDLE FILTER ===
candleBody = math.abs(close - open)
candleRange = high - low
strongBull = close > open and candleBody / candleRange >= strongCandlePerc
strongBear = open > close and candleBody / candleRange >= strongCandlePerc

// === ENTRY CONDITIONS ===
buyCondition = ta.crossover(emaFast, emaSlow) and (slopeFast - slopeSlow > slopeThresh) and volumeOk and strongBull
sellCondition = ta.crossunder(emaFast, emaSlow) and (slopeSlow - slopeFast > slopeThresh) and volumeOk and strongBear

// === STOP LOSS AND TAKE PROFIT ===
longSL = low[0]
shortSL = high[0]

longTP = close + (close - longSL) * rr
shortTP = close - (shortSL - close) * rr

// === STRATEGY EXECUTION ===
if buyCondition
    strategy.entry("Long", strategy.long)
    strategy.exit("Long Exit", "Long", stop=longSL, limit=longTP)
    // Labels for Entry, SL, TP
    label.new(bar_index, close, text="Entry: " + str.tostring(close, format.mintick), style=label.style_label_up, color=color.green, textcolor=color.white, yloc=yloc.price)
    label.new(bar_index, longSL, text="SL: " + str.tostring(longSL, format.mintick), style=label.style_label_down, color=color.red, textcolor=color.white, yloc=yloc.price)
    label.new(bar_index, longTP, text="TP: " + str.tostring(longTP, format.mintick), style=label.style_label_up, color=color.blue, textcolor=color.white, yloc=yloc.price)

if sellCondition
    strategy.entry("Short", strategy.short)
    strategy.exit("Short Exit", "Short", stop=shortSL, limit=shortTP)
    // Labels for Entry, SL, TP
    label.new(bar_index, close, text="Entry: " + str.tostring(close, format.mintick), style=label.style_label_down, color=color.green, textcolor=color.white, yloc=yloc.price)
    label.new(bar_index, shortSL, text="SL: " + str.tostring(shortSL, format.mintick), style=label.style_label_up, color=color.red, textcolor=color.white, yloc=yloc.price)
    label.new(bar_index, shortTP, text="TP: " + str.tostring(shortTP, format.mintick), style=label.style_label_down, color=color.blue, textcolor=color.white, yloc=yloc.price)
