//@version=5
strategy("TradeRoom-style EMA Angle Strategy (A2 + ATR scaling)", overlay=true, 
  default_qty_type=strategy.percent_of_equity, default_qty_value=5,
  pyramiding=1, calc_on_every_tick=true)

// ----------------- INPUTS -----------------
res        = input.timeframe("15", "Signal timeframe")
emaFastLen = input.int(9, "EMA Fast")
emaSlowLen = input.int(15, "EMA Slow")

slopeBars  = input.int(3, "Slope lookback (A2 = 3)", minval=1)
atrLen     = input.int(14, "ATR length (B1 = 14)", minval=1)

minAngleDeg = input.float(25.0, "Min angle (deg)")
maxAngleDeg = input.float(30.0, "Max angle (deg)")

strongBodyAtrFactor = input.float(0.25, "Strong body threshold (ATR * factor)")

entrySizePerc = input.float(5.0, "Order size (% of equity)", minval=0.1, maxval=100)

// ----------------- FETCH HTF SERIES -----------------
emaFast_res = request.security(syminfo.tickerid, res, ta.ema(close, emaFastLen), lookahead=barmerge.lookahead_off)
emaSlow_res = request.security(syminfo.tickerid, res, ta.ema(close, emaSlowLen), lookahead=barmerge.lookahead_off)
atr_res     = request.security(syminfo.tickerid, res, ta.atr(atrLen),           lookahead=barmerge.lookahead_off)

emaFast_prev = emaFast_res[slopeBars]
emaSlow_prev = emaSlow_res[slopeBars]

slopeFast = emaFast_res - emaFast_prev
priceScale = atr_res != 0 ? atr_res : 1e-8

// ⭐ Convert slope to angle in degrees
angleRad = math.atan(slopeFast / priceScale)
angleDeg = angleRad * 180 / (math.pi)
absAngleDeg = math.abs(angleDeg)

// ----------------- EMA & ANGLE CONDITIONS -----------------
emaBullCond = emaFast_res > emaSlow_res
emaBearCond = emaFast_res < emaSlow_res

angleOK = (absAngleDeg >= minAngleDeg) and (absAngleDeg <= maxAngleDeg)

// ----------------- CANDLE PATTERNS (HTF candle) -----------------
sig_open  = request.security(syminfo.tickerid, res, open,  lookahead=barmerge.lookahead_off)
sig_high  = request.security(syminfo.tickerid, res, high,  lookahead=barmerge.lookahead_off)
sig_low   = request.security(syminfo.tickerid, res, low,   lookahead=barmerge.lookahead_off)
sig_close = request.security(syminfo.tickerid, res, close, lookahead=barmerge.lookahead_off)

sig_body = math.abs(sig_close - sig_open)
sig_upperWick = sig_high - math.max(sig_open, sig_close)
sig_lowerWick = math.min(sig_open, sig_close) - sig_low

isHammer_bull    = (sig_lowerWick >= 2 * sig_body) and (sig_upperWick <= sig_body * 0.3)
isInvHammer_bear = (sig_upperWick >= 2 * sig_body) and (sig_lowerWick <= sig_body * 0.3)
isMarubozu       = (sig_upperWick <= sig_body * 0.1) and (sig_lowerWick <= sig_body * 0.1)

isStrongGreen = (sig_close > sig_open) and (sig_body >= atr_res * strongBodyAtrFactor)
isStrongRed   = (sig_close < sig_open) and (sig_body >= atr_res * strongBodyAtrFactor)

bullCandleSignal = isHammer_bull or isMarubozu or isStrongGreen
bearCandleSignal = isInvHammer_bear or isMarubozu or isStrongRed

// ----------------- ENTRY LOGIC -----------------
sig_changed = sig_close != sig_close[1]  // only one entry per HTF bar

longSignal  = emaBullCond and angleOK and bullCandleSignal and sig_changed
shortSignal = emaBearCond and angleOK and bearCandleSignal and sig_changed

var longId  = "Long"
var shortId = "Short"

if longSignal
    sl = sig_low
    entry = close
    dist = entry - sl
    if dist > 0
        tp = entry + 2 * dist
        strategy.entry(longId, strategy.long, qty=entrySizePerc)
        strategy.exit("ExitLong", from_entry=longId, stop=sl, limit=tp)

if shortSignal
    sl = sig_high
    entry = close
    dist = sl - entry
    if dist > 0
        tp = entry - 2 * dist
        strategy.entry(shortId, strategy.short, qty=entrySizePerc)
        strategy.exit("ExitShort", from_entry=shortId, stop=sl, limit=tp)

// ----------------- PLOTS -----------------
plot(emaFast_res, color=color.new(color.green,0), linewidth=2, title="EMA9")
plot(emaSlow_res, color=color.new(color.red,0),   linewidth=2, title="EMA15")

plotchar(longSignal,  "Long",  "▲", location=location.belowbar, color=color.green)
plotchar(shortSignal, "Short", "▼", location=location.abovebar, color=color.red)

